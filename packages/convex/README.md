# @openscience/convex

Convex backend for the Open Science distributed research platform.

## What This Is

The coordination server that manages:
- Research tasks and verification pipeline
- Knowledge base (findings) with 3-of-3 verification
- Hypotheses and scientific loop
- Lab notebooks (reasoning audit trail)
- Contributors and their stats
- Tickets for human escalation

## Development

### First-time setup

1. Install dependencies:
   ```bash
   bun install
   ```

2. Set up Convex project:
   ```bash
   bun dev
   ```

   This will prompt you to:
   - Create a Convex account (if you don't have one)
   - Create a new project or link to an existing one
   - Generate the `convex/_generated` files

### Running the dev server

```bash
bun dev
```

This starts the Convex dev server with hot-reloading. Any changes to schema or functions will be automatically deployed to your dev deployment.

### Type checking

```bash
bun typecheck
```

### Building

```bash
bun build
```

Runs `convex codegen` to regenerate TypeScript types from your schema.

## Project Structure

```
packages/convex/
├── convex/                    # Convex backend functions
│   ├── schema.ts             # Database schema (THE KEY FILE)
│   ├── _generated/           # Auto-generated by Convex (gitignored)
│   └── tsconfig.json         # TypeScript config for Convex functions
├── src/
│   └── index.ts              # Re-exports API for use by other packages
├── package.json
├── tsconfig.json
├── convex.json               # Convex configuration
└── README.md                 # This file
```

## Schema Overview

See `convex/schema.ts` for the full schema. Key tables:

- **projects**: Research projects (e.g., neoantigen immunogenicity)
- **tasks**: Research and verification tasks with DAG structure
- **findings**: Knowledge base entries (pending → verified/rejected)
- **verifications**: 3-of-3 verification votes
- **hypotheses**: Scientific loop (proposed → testing → supported/refuted)
- **labNotebooks**: Agent reasoning audit trail
- **contributors**: Platform participants
- **tickets**: Human escalation (NEED_GPU, NEED_SCIENTIST, etc.)

## Key Patterns

### Self-contained tasks
Tasks carry their own context, assembled by the server at claim time from the knowledge base and related findings.

### 3-of-3 verification
Each finding needs 3 independent PASS votes to be verified. Any FAIL vote creates a re-research task.

### Scientific loop
Hypotheses automatically spawn test tasks. Results feed back as context for new hypotheses.

### Suspension/continuation
Frozen pi-mono sessions are stored in Convex file storage for agent suspension/resumption.

## Next Steps

After the Convex backend is set up:
1. Implement core mutations/queries (tasks.ts, findings.ts, hypotheses.ts)
2. Build the CLI agent in `apps/cli`
3. Create the web dashboard in `apps/web`

## Related Packages

- `apps/cli` - CLI agent that claims tasks and submits findings
- `apps/web` - Public dashboard (planned)
